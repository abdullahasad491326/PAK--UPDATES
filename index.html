<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIM DB AI // Advanced Toolkit</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-color: #f4f7fa;
    --card-bg: rgba(255, 255, 255, 0.7);
    --text-color: #1a202c;
    --text-muted-color: #4a5568;
    --border-color: rgba(0, 0, 0, 0.08);
    --aurora-color-1: rgba(59, 130, 246, 0.2);
    --aurora-color-2: rgba(147, 51, 234, 0.2);
    --accent-color: #3b82f6;
    --accent-glow: rgba(59, 130, 246, 0.4);
  }
  html.dark {
    --bg-color: #0b1120;
    --card-bg: rgba(15, 23, 42, 0.5);
    --text-color: #e2e8f0;
    --text-muted-color: #94a3b8;
    --border-color: rgba(255, 255, 255, 0.1);
    --aurora-color-1: rgba(22, 163, 74, 0.25);
    --aurora-color-2: rgba(34, 211, 238, 0.25);
    --accent-color: #22d3ee;
    --accent-glow: rgba(34, 211, 238, 0.4);
  }
  body { 
    font-family: 'Inter', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-color); 
    overflow-x: hidden; 
    transition: background-color 0.3s ease;
    background-image: linear-gradient(rgba(128,128,128,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(128,128,128,0.03) 1px, transparent 1px);
    background-size: 20px 20px;
  }
  
  /* Background & Cards */
  #aurora-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -2; overflow: hidden; }
  #aurora-container::before, #aurora-container::after { content: ''; position: absolute; top: 50%; left: 50%; width: 120vmax; height: 120vmax; background: radial-gradient(circle, var(--aurora-color-1), transparent 50%); border-radius: 50%; transform: translate(-50%, -50%); animation: aurora-move 20s infinite linear alternate; }
  #aurora-container::after { background: radial-gradient(circle, var(--aurora-color-2), transparent 50%); animation: aurora-move-2 20s infinite linear alternate; animation-delay: -10s; }
  @keyframes aurora-move { from { transform: translate(-55%, -60%) rotate(0deg); } to { transform: translate(-45%, -40%) rotate(360deg); } }
  @keyframes aurora-move-2 { from { transform: translate(-45%, -40%) rotate(0deg); } to { transform: translate(-55%, -50%) rotate(-360deg); } }
  .glass-card { background: var(--card-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border-color); animation: fadeIn 1s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Input & Server Status */
  .input-wrapper .validation-icon { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%) scale(0); transition: transform 0.2s ease; }
  .input-wrapper.valid .icon-valid, .input-wrapper.invalid .icon-invalid { transform: translateY(-50%) scale(1); }
  .status-dot { height: 8px; width: 8px; border-radius: 50%; transition: background-color 0.3s; }
  .status-dot.online { background-color: #22c55e; box-shadow: 0 0 6px #22c55e; animation: pulse-green 2s infinite; }
  .status-dot.slow { background-color: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
  .status-dot.offline { background-color: #ef4444; }
  @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

  /* Utilities */
  .btn-primary { background-color: var(--accent-color); color: white; transition: all 0.2s ease; }
  .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 20px var(--accent-glow); }
  .btn-primary:disabled { cursor: not-allowed; background-color: var(--text-muted-color); opacity: 0.7; }
  .spinner { border: 2px solid #ffffff30; border-top: 2px solid #fff; border-radius: 50%; width: 1.25rem; height: 1.25rem; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); z-index: 100; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
  #toast-notification.show { bottom: 30px; }
  .result-card { animation: fadeIn 0.5s ease; }
</style>
</head>
<body class="p-4 sm:p-6">

<div id="aurora-container"></div>
<div id="toast-notification"></div>

<div class="container mx-auto max-w-2xl space-y-6">
  
  <header class="flex justify-between items-center">
    <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-cyan-400 dark:from-cyan-300 dark:to-green-400">SIM Database AI</h1>
    <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-500/10" title="Toggle Theme"></button>
  </header>

  <main class="glass-card rounded-2xl p-6 shadow-lg">
    <div class="input-wrapper relative mb-4">
      <input id="search-input" type="tel" placeholder="Enter number or CNIC..." class="w-full p-4 pl-5 pr-12 rounded-xl border bg-white/50 dark:bg-black/20 border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-color)] outline-none transition">
      <div class="validation-icon">
        <svg class="icon-valid h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        <svg class="icon-invalid h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </div>
    </div>

    <div class="grid sm:grid-cols-2 gap-4 mt-4">
      <div id="server-selector" class="p-1 rounded-lg flex justify-between bg-gray-500/10">
        <button data-server="1" class="server-btn flex-1 py-2 text-sm font-semibold rounded-md flex items-center justify-center gap-2"><div class="status-dot"></div><span>S1</span></button>
        <button data-server="2" class="server-btn flex-1 py-2 text-sm font-semibold rounded-md flex items-center justify-center gap-2"><div class="status-dot"></div><span>S2</span></button>
        <button data-server="3" class="server-btn flex-1 py-2 text-sm font-semibold rounded-md flex items-center justify-center gap-2"><div class="status-dot"></div><span>S3</span></button>
      </div>
      <button id="search-btn" class="w-full py-3 rounded-xl btn-primary flex items-center justify-center gap-2 font-semibold">
        <span id="search-btn-text">Search</span>
        <div id="search-btn-spinner" class="spinner hidden"></div>
      </button>
    </div>
  </main>
  
  <section class="grid md:grid-cols-2 gap-6">
    <div id="dashboard-card" class="glass-card rounded-2xl p-6 shadow-lg">
      <h2 class="font-bold mb-4 text-lg">Session Analytics</h2>
      <div class="grid grid-cols-2 gap-4 text-center">
        <div class="bg-gray-500/5 p-4 rounded-lg">
          <div id="stats-total" class="text-3xl font-bold text-[var(--accent-color)]">0</div>
          <p class="text-sm text-muted-color">Total Searches</p>
        </div>
        <div class="bg-gray-500/5 p-4 rounded-lg">
          <div id="stats-success" class="text-3xl font-bold text-[var(--accent-color)]">0%</div>
          <p class="text-sm text-muted-color">Success Rate</p>
        </div>
      </div>
    </div>
    <div id="history-panel" class="glass-card rounded-2xl p-6 shadow-lg hidden">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold text-lg">Search History</h3>
        <button id="clear-history-btn" class="text-sm text-blue-500 hover:underline">Clear</button>
      </div>
      <div id="history-list" class="space-y-1 text-sm max-h-24 overflow-y-auto pr-2"></div>
    </div>
  </section>

  <div id="result-container" class="mt-4"></div>
            </div>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  // --- STATE MANAGEMENT ---
  const state = {
    isLoading: false,
    selectedServer: '1',
    servers: {
      '1': { status: 'unknown', url: 'https://texify.xyz/api/check' },
      '2': { status: 'unknown', url: 'https://livetrackersimdata.online/sim-owner-check.php' },
      '3': { status: 'unknown', url: 'https://simownershipdata.info/sim-owner-check.php' }
    },
    analytics: JSON.parse(localStorage.getItem('simDbAnalytics')) || { total: 0, success: 0 },
    history: JSON.parse(localStorage.getItem('simDbHistory')) || []
  };

  // --- DOM ELEMENT SELECTORS ---
  const DOMElements = {
    themeToggle: document.getElementById('theme-toggle'),
    searchInput: document.getElementById('search-input'),
    serverSelector: document.getElementById('server-selector'),
    searchBtn: document.getElementById('search-btn'),
    searchBtnText: document.getElementById('search-btn-text'),
    searchBtnSpinner: document.getElementById('search-btn-spinner'),
    resultContainer: document.getElementById('result-container'),
    statsTotal: document.getElementById('stats-total'),
    statsSuccess: document.getElementById('stats-success'),
    historyPanel: document.getElementById('history-panel'),
    historyList: document.getElementById('history-list'),
    clearHistoryBtn: document.getElementById('clear-history-btn'),
    toast: document.getElementById('toast-notification')
  };

  // --- CORE FUNCTIONS ---

  /** Manages the main loading state of the UI */
  const setLoading = (isLoading) => {
    state.isLoading = isLoading;
    DOMElements.searchBtn.disabled = isLoading;
    DOMElements.searchBtnText.classList.toggle('hidden', isLoading);
    DOMElements.searchBtnSpinner.classList.toggle('hidden', !isLoading);
  };
  
  /** Shows a toast notification */
  const showToast = (message, type = 'info') => {
    DOMElements.toast.textContent = message;
    DOMElements.toast.className = `py-3 px-6 rounded-lg z-50 shadow-lg font-semibold ${type === 'error' ? 'bg-red-500 text-white' : 'bg-[var(--accent-color)] text-white'}`;
    DOMElements.toast.classList.add('show');
    setTimeout(() => DOMElements.toast.classList.remove('show'), 3000);
  };
  
  /** Updates the analytics dashboard */
  const updateAnalytics = (isSuccess = null) => {
    if (isSuccess !== null) {
      state.analytics.total++;
      if (isSuccess) state.analytics.success++;
      localStorage.setItem('simDbAnalytics', JSON.stringify(state.analytics));
    }
    const successRate = state.analytics.total > 0 ? Math.round((state.analytics.success / state.analytics.total) * 100) : 0;
    animateCounter(DOMElements.statsTotal, state.analytics.total);
    animateCounter(DOMElements.statsSuccess, successRate, '%');
  };
  
  /** Animates a number counting up */
  const animateCounter = (el, to, suffix = '') => {
      const from = parseInt(el.textContent.replace(suffix, '')) || 0;
      if (from === to) return;
      const duration = 1000;
      let start = null;
      const step = timestamp => {
          if (!start) start = timestamp;
          const progress = Math.min((timestamp - start) / duration, 1);
          el.textContent = Math.floor(progress * (to - from) + from) + suffix;
          if (progress < 1) window.requestAnimationFrame(step);
      };
      window.requestAnimationFrame(step);
  };

  /** Handles the main search logic */
  const handleSearch = async () => {
    const query = DOMElements.searchInput.value.trim();
    if (!validateQuery(query)) {
      showToast('Invalid input format. Use 03xxxxxxxxx or a 13-digit CNIC.', 'error');
      return;
    }
    
    setLoading(true);
    // This try...finally block is crucial. The 'finally' part will run
    // whether the search succeeds or fails, ensuring the loading state is always reset.
    try {
      DOMElements.resultContainer.innerHTML = '';
      const result = await fetchApi(query);
      updateAnalytics(result.success);
      renderResult(result);
      if (result.success) updateHistory(query);
    } catch (error) {
      console.error("An unexpected error occurred during search:", error);
      showToast("An unexpected error occurred.", "error");
    } finally {
      setLoading(false);
    }
  };

  /** Generic API fetch function for the selected server */
  const fetchApi = async (query) => {
    const server = state.servers[state.selectedServer];
    let url = server.url;
    let options = { method: 'GET' };

    if (state.selectedServer === '1') {
      url = `${url}?q=${query}`;
    } else {
      options.method = 'POST';
      const formData = new FormData();
      formData.append('searchNumber', query);
      options.body = formData;
    }

    try {
      const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, options);
      if (!response.ok) throw new Error('Network error');
      const data = await response.json();
      if ((data.success || data.status === 'success') && (data.data?.length > 0 || data.total > 0)) {
        return { success: true, data: data.data[0] };
      }
      return { success: false, error: 'No data found' };
    } catch (error) {
      console.error(`API Error on Server ${state.selectedServer}:`, error);
      return { success: false, error: 'Failed to fetch data' };
    }
  };

  /** Renders a single result card to the DOM */
  const renderResult = (result) => {
    if (!result.success) {
      DOMElements.resultContainer.innerHTML = `<div class="result-card glass-card text-center p-6 rounded-xl text-red-500">${result.error || 'An unknown error occurred.'}</div>`;
      return;
    }
    const data = result.data;
    const cardHTML = `
      <div class="result-card glass-card rounded-xl p-6 border shadow-sm">
        <h3 class="text-lg font-bold mb-4 border-b border-[var(--border-color)] pb-2">Search Result</h3>
        <div class="space-y-3 text-sm">
          <p><strong>Name:</strong> ${data.name || 'N/A'}</p>
          <p><strong>Number:</strong> ${data.number || data.phone || 'N/A'}</p>
          <p><strong>CNIC:</strong> ${data.cnic || 'N/A'}</p>
          <p><strong>Address:</strong> ${data.address || 'N/A'}</p>
        </div>
      </div>
    `;
    DOMElements.resultContainer.innerHTML = cardHTML;
  };
  
  // --- UI & EVENT HANDLERS ---
  const setupEventListeners = () => {
    DOMElements.themeToggle.addEventListener('click', toggleTheme);
    DOMElements.serverSelector.addEventListener('click', handleServerSelect);
    DOMElements.searchBtn.addEventListener('click', handleSearch);
    DOMElements.searchInput.addEventListener('input', (e) => validateInput(e.target));
    DOMElements.searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(); });
    DOMElements.clearHistoryBtn.addEventListener('click', clearHistory);
    DOMElements.historyList.addEventListener('click', handleHistoryClick);
  };
  
  const handleServerSelect = (e) => {
      const btn = e.target.closest('.server-btn');
      if (!btn) return;
      document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('bg-black/10', 'dark:bg-white/10'));
      btn.classList.add('bg-black/10', 'dark:bg-white/10');
      state.selectedServer = btn.dataset.server;
  };

  const validateInput = (input) => {
    const value = input.value.trim();
    const isValid = validateQuery(value);
    const wrapper = input.parentElement;
    wrapper.classList.toggle('valid', isValid);
    wrapper.classList.toggle('invalid', value.length > 0 && !isValid);
  };

  const validateQuery = (query) => /^(03\d{9})$|^\d{13}$/.test(query);

  // --- HISTORY FUNCTIONS ---
  const updateHistory = (query) => {
      state.history = state.history.filter(item => item !== query);
      state.history.unshift(query);
      if (state.history.length > 5) state.history.pop();
      localStorage.setItem('simDbHistory', JSON.stringify(state.history));
      renderHistory();
  };
  
  const renderHistory = () => {
      if (state.history.length === 0) {
          DOMElements.historyPanel.classList.add('hidden');
          return;
      }
      DOMElements.historyPanel.classList.remove('hidden');
      DOMElements.historyList.innerHTML = state.history.map(item =>
          `<div class="history-item p-2 rounded-md hover:bg-gray-500/10 cursor-pointer">${item}</div>`
      ).join('');
  };
  
  const clearHistory = () => {
      state.history = [];
      localStorage.removeItem('simDbHistory');
      renderHistory();
  };

  const handleHistoryClick = (e) => {
      const item = e.target.closest('.history-item');
      if (item) {
          DOMElements.searchInput.value = item.textContent;
          validateInput(DOMElements.searchInput);
          handleSearch();
      }
  };

  // --- SERVER STATUS PINGER ---
  const pingAllServers = async () => {
    for (const id in state.servers) {
      const serverUrl = state.servers[id].url;
      const statusEl = document.querySelector(`.server-btn[data-server='${id}'] .status-dot`);
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 3000);
      try {
        const startTime = performance.now();
        await fetch(`https://corsproxy.io/?${encodeURIComponent(serverUrl)}`, { method: 'HEAD', signal: controller.signal });
        const endTime = performance.now();
        clearTimeout(timeoutId);
        const duration = endTime - startTime;
        statusEl.classList.remove('offline');
        statusEl.classList.add(duration > 1500 ? 'slow' : 'online');
      } catch (error) {
        clearTimeout(timeoutId);
        statusEl.className = 'status-dot offline';
      }
    }
  };

  // --- THEME ---
  const toggleTheme = () => {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeUI(isDark);
  };
  const updateThemeUI = (isDark) => {
    DOMElements.themeToggle.innerHTML = isDark 
      ? `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>`
      : `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>`;
  };
  
  // --- INITIALIZATION ---
  const init = () => {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);
    if (isDark) document.documentElement.classList.add('dark');
    updateThemeUI(isDark);
    document.querySelector('.server-btn[data-server="1"]').classList.add('bg-black/10', 'dark:bg-white/10');
    updateAnalytics();
    renderHistory();
    setupEventListeners();
    pingAllServers();
  };

  init();
});
</script>
</body>
</html>
